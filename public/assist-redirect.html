<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirection assistance √† distance</title>
    <link rel="icon" type="image/x-icon" href="/pics/favicon.ico">
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #26a69a 0%, #00897b 100%);
            color: white;
        }
        .container {
            text-align: center;
            background: rgba(255,255,255,0.15);
            padding: 40px 50px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            max-width: 500px;
        }
        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            color: #ffebee;
            background: rgba(244, 67, 54, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            white-space: pre-line;
        }
        .error a {
            color: #fff;
            text-decoration: underline;
            font-weight: bold;
        }
        .error a:hover {
            color: #e3f2fd;
        }
        .success {
            color: #e8f5e9;
            background: rgba(76, 175, 80, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .countdown {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 10px;
        }
        h1 {
            margin-bottom: 10px;
            font-size: 1.8em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñ•Ô∏è Lancement de l'assistance √† distance...</h1>
        <div class="spinner" id="spinner"></div>
        <p id="status">Initialisation...</p>
        <p id="message" style="display:none;"></p>
        <p id="countdown" class="countdown" style="display:none;"></p>
    </div>

    <script>
        // R√©cup√©ration des param√®tres depuis l'URL
        const urlParams = new URLSearchParams(window.location.search);
        const computerName = urlParams.get('computer');
        const protocol = urlParams.get('protocol') || 'assist-msra'; // Par d√©faut: assist-msra
        
        const statusEl = document.getElementById('status');
        const messageEl = document.getElementById('message');
        const countdownEl = document.getElementById('countdown');
        const spinnerEl = document.getElementById('spinner');

        // Validation du protocole
        const validProtocols = ['assist-msra', 'ctrl-dw'];
        
        function hideSpinner() {
            if (spinnerEl) {
                spinnerEl.style.display = 'none';
            }
        }
        
        function showError(title, message, delay) {
            hideSpinner();
            statusEl.textContent = title;
            messageEl.textContent = message;
            messageEl.className = 'error';
            messageEl.style.display = 'block';
            
            // Compte √† rebours
            let secondsLeft = Math.floor(delay / 1000);
            countdownEl.textContent = `Retour automatique dans ${secondsLeft} seconde(s)...`;
            countdownEl.style.display = 'block';
            
            const countdownInterval = setInterval(() => {
                secondsLeft--;
                if (secondsLeft > 0) {
                    countdownEl.textContent = `Retour automatique dans ${secondsLeft} seconde(s)...`;
                } else {
                    clearInterval(countdownInterval);
                }
            }, 1000);
            
            // Retour √† la page pr√©c√©dente apr√®s le d√©lai
            setTimeout(() => {
                window.history.back();
            }, delay);
        }
        
        function showSuccess(title, message, delay) {
            hideSpinner();
            statusEl.textContent = title;
            messageEl.textContent = message;
            messageEl.className = 'success';
            messageEl.style.display = 'block';
            
            // Compte √† rebours
            let secondsLeft = Math.floor(delay / 1000);
            countdownEl.textContent = `Retour automatique dans ${secondsLeft} seconde(s)...`;
            countdownEl.style.display = 'block';
            
            const countdownInterval = setInterval(() => {
                secondsLeft--;
                if (secondsLeft > 0) {
                    countdownEl.textContent = `Retour automatique dans ${secondsLeft} seconde(s)...`;
                } else {
                    clearInterval(countdownInterval);
                }
            }, 1000);
            
            // Retour √† la page pr√©c√©dente apr√®s le d√©lai
            setTimeout(() => {
                window.history.back();
            }, delay);
        }
        
        if (!validProtocols.includes(protocol)) {
            showError(
                '‚ùå Protocole invalide',
                `Le protocole "${protocol}" n'est pas support√©. Protocoles valides : ${validProtocols.join(', ')}`,
                12000 // 12 secondes
            );
        } else if (!computerName) {
            showError(
                '‚ùå Nom d\'ordinateur manquant',
                'Aucun nom d\'ordinateur n\'a √©t√© fourni dans l\'URL. Veuillez r√©essayer.',
                10000 // 10 secondes
            );
        } else {
            // Affichage du protocole utilis√©
            const protocolNames = {
                'assist-msra': 'Microsoft Remote Assistance',
                'ctrl-dw': 'Dameware Remote Control'
            };
            
            statusEl.textContent = `‚úì Connexion vers : ${computerName}`;
            statusEl.innerHTML += `<br><small style="opacity: 0.9;">Protocole : ${protocolNames[protocol]}</small>`;
            
            // Construction de l'URL du protocole
            const protocolUrl = `${protocol}://${computerName}`;
            
            // Variable pour suivre si l'utilisateur a quitt√© la page (protocole lanc√© avec succ√®s)
            let protocolLaunched = false;
            let blurDetected = false;
            
            // D√©tecter si la fen√™tre perd le focus (l'application externe s'ouvre)
            const onBlur = () => {
                blurDetected = true;
                protocolLaunched = true;
            };
            
            // D√©tecter si l'utilisateur revient sur la page (visibilitychange)
            const onVisibilityChange = () => {
                if (document.hidden === false && blurDetected) {
                    // L'utilisateur est revenu, l'application a probablement √©t√© lanc√©e
                    protocolLaunched = true;
                }
            };
            
            window.addEventListener('blur', onBlur);
            document.addEventListener('visibilitychange', onVisibilityChange);
            
            // Tentative de lancement du protocole via iframe
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = protocolUrl;
            document.body.appendChild(iframe);
            
            // Attendre pour v√©rifier si le protocole a √©t√© lanc√©
            setTimeout(() => {
                // Nettoyer les listeners
                window.removeEventListener('blur', onBlur);
                document.removeEventListener('visibilitychange', onVisibilityChange);
                
                if (protocolLaunched) {
                    // Le protocole semble avoir √©t√© lanc√© (la fen√™tre a perdu le focus)
                    showSuccess(
                        '‚úì Protocole lanc√© avec succ√®s',
                        `L'application ${protocolNames[protocol]} a √©t√© ouverte.`,
                        3000 // 3 secondes
                    );
                } else {
                    // Le protocole n'a probablement pas √©t√© lanc√©
                    const githubLink = 'https://github.com/SpyKeeR/rcbuttons/blob/main/install-protocols.bat';
                    hideSpinner();
                    statusEl.textContent = '‚ö†Ô∏è Gestionnaire de protocole manquant';
                    messageEl.innerHTML = `Le protocole "<strong>${protocol}://</strong>" n'est pas install√© sur votre poste.<br><br>T√©l√©chargez et ex√©cutez <strong>install-assist-protocols.bat</strong> en tant qu'administrateur.<br><br>üì• <a href="${githubLink}" target="_blank">T√©l√©charger depuis GitHub</a>`;
                    messageEl.className = 'error';
                    messageEl.style.display = 'block';
                    
                    // Compte √† rebours
                    let secondsLeft = 15;
                    countdownEl.textContent = `Retour automatique dans ${secondsLeft} seconde(s)...`;
                    countdownEl.style.display = 'block';
                    
                    const countdownInterval = setInterval(() => {
                        secondsLeft--;
                        if (secondsLeft > 0) {
                            countdownEl.textContent = `Retour automatique dans ${secondsLeft} seconde(s)...`;
                        } else {
                            clearInterval(countdownInterval);
                        }
                    }, 1000);
                    
                    // Retour √† la page pr√©c√©dente apr√®s le d√©lai
                    setTimeout(() => {
                        window.history.back();
                    }, 15000);
                }
            }, 2000); // Attendre 2 secondes pour d√©tecter le blur
        }
    </script>
</body>
</html>
